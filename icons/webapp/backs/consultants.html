<html>
<head>
<meta http-equiv = "content-type" content = "application/xhtml+xml; charset = UTF-8" />
<meta content = 'width = device-width, initial-scale = 1.0, maximum-scale = 1.0, user-scalable = 0' name = 'viewport' /><meta name = "viewport" content = "width = device-width, maximum-scale = 1.0, initial-scale = 1.0">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<title>Test CP Data</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
<script>
var ddiv;
var data;
var linkArray=[];
var linkCount=0;
var lines = [];
var l=0;
var questions=[];

function init(){
  ddiv=document.getElementById('debugDiv');

  // Check for the various File API support.
  if (window.File && window.FileReader && window.FileList && window.Blob) {
    // Great success! All the File APIs are supported.
    }  
  else {
    alert('The File APIs are not fully supported in this browser.');
    }
  document.getElementById('files').addEventListener('change', handleFileSelect, false);
  }


var cpData ={};
function handleFileSelect(evt) {
  var files = evt.target.files; // FileList object
  document.getElementById('files').style.display="none";
  // files is a FileList of File objects. List some properties.
  var output = [];
  for (var i = 0, f; f = files[i]; i++) {
    output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
    f.size, ' bytes, last modified: ',
    f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
    '</li>');
    }
  //document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';

  var file = files[0];
  dbuga("file:"+file);
  var reader = new FileReader();
  reader.onload = function(progressEvent){
    var atTable="";
    var inRecords=false;
    // Entire file
    // console.log(this.result);
    var lines = this.result.split('\n');
    dbuga("lines.length="+lines.length);
    var atRecord=0;
    for(var l=0; l<lines.length; l++){
      if(lines[l].indexOf("\\.")==0){
        cpData[atTable].recordCount=atRecord;
        inRecords=false;
        }
      if(lines[l].indexOf("COPY ")==0){
        atRecord=0;
        var line= lines[l].replace(") FROM stdin;", "");
        line=line.replace("COPY ", "");
        var parts=line.split(" (");
        var tableName=parts[0];
        atTable=tableName;
        var fieldGlom=parts[1];
        cpData[tableName]={"name":tableName, "fields":fieldGlom.split(", "), "recordCount":0, "records":[]};
        inRecords=true;
        }
      else{
        atRecord++
        if(inRecords){
          if(lines[l].length>0){
            cpData[atTable].records.push(lines[l]);
            }
          }
        }
      /* var tabs = lines[line].split('\\t'); */
      }
    var keys=Object.keys(cpData);
    for (var k=0; k<keys.length; k++){
      var tableName=keys[k];
      //dbuga("<b>"+ cpData[tableName].name+"</b> <i>"+ cpData[tableName].recordCount+" records </i><br> "+ cpData[tableName].fields.join(" "));
      }
    dbuga('have data');
    parseMembers();
    //parseAssessments();
    //testWrite();
    dbuga('completed init');
    };
  reader.readAsText(file);
  }

//6921: "7021	\N	\N	\N	\N	\N	\N	\N	7021	checked	\N	\N	'baddata	\N	/images/transparent.gif	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	checked	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N"

var emailsAll=[];
var emailsAndMemberIds=[];

function parseMembers(){
  var fields=cpData.member.fields;
  var records=cpData.member.records;
  for(var r=0; r<records.length; r++){
    if(records[r].indexOf("baddata")==-1){
      var member={"liscenses":0, "clientEmails":[], "clientNames":[], "clientUsernames":[], "clientPasswords":[]};

      var parts=records[r].split("\t");
      for (var p=0; p<parts.length; p++){
        if(parts[p]=="\\N"){parts[p]="";}
        member[fields[p]]=parts[p];
        }
      var memberId=member.member_id;
      memberIds.push(memberId);
      membersById[memberId]=member;
      member.email=member.email.toLowerCase();
      if(member.email.indexOf("@")>-1){
        if(valueInArray(member.email, emailsAll)==false){
          memberIdsByEmail[member.email]=[memberId];
          emailsAll.push(member.email);
          }
        else{
          memberIdsByEmail[member.email].push(memberId);
          }
        }
      }
    }
  dbuga('finished parse members ');

  dbuga(' so gatherClients(); (about one minute)');
  window.setTimeout('gatherClients()', 100);
  }
function gatherClients(){
  for (var m=0; m<memberIds.length; m++){
    var member=membersById[memberIds[m]];
    if(member.isconsultant=="checked"){
      consultantIdQueue.push(memberIds[m]);
      }
    if(member.consultant_id != ""){
      if(valueInArray(member.consultant_id, Object.keys(membersById))){
        if(member.email != ""){
          if(valueInArray(member.email, membersById[member.consultant_id].clientEmails)==false){
            membersById[member.consultant_id].clientEmails.push(member.email);
            membersById[member.consultant_id].clientNames.push(member.fname+" "+member.lname);
            membersById[member.consultant_id].clientUsernames.push(member.username);
            membersById[member.consultant_id].clientPasswords.push(member.password);
            }
          }
        }
      else{
        console.log(member.consultant_id+" consultant not in membersById");
        }
      }
    }
  dbuga('finished gatherClients() ');


  dbuga(' so outputConsultants (about one minute)');
  //window.setTimeout('outputConsultants()', 100);
  //window.setTimeout('outputAllConsultants()', 100);
  window.setTimeout('detailAllConsultants()', 100);


  }

var consultantIdQueue=[];
var consultantFiles=[];
function detailAllConsultants(){
  dbuga('detailAllConsultants()');
  var linesArray=[];
  for(var i=0; i<consultantIdQueue.length; i++){
    var consultantId=consultantIdQueue[i];
    dbuga('consultantId='+consultantId);
    var member=membersById[consultantId];
    dbuga('member.email='+member.email);
    dbuga('member.username='+member.username);
    dbuga('member.password='+member.password);
    var consultantLine=member.member_id+"\t"+member.lname+", "+member.fname+"\t"+member.email+"\t"+member.username+"\t"+member.password;
    var emails=member.clientEmails;
    var names=member.clientNames;
    var usernames=member.clientUsernames;
    var passwords=member.clientPasswords;
    for(var e=0; e<emails.length; e++){
      linesArray.push(consultantLine+"\t"+names[e]+"\t"+emails[e]+"\t"+usernames[e]+"\t"+passwords[e]);
      }
    }
  var outStr=linesArray.join("\n");
  $.post("saveit.php", {
    file : "consultants_emails.txt",
    content : outStr
    }, 
    function(data) {
      dbuga('saved <a href="'+data+'">'+data+'</a>');

    });
  }

function outputAllConsultants(){
  dbuga('outputAllConsultants()');
  var linesArray=["member_id\tConsultant\tEmail\tClients\tClient Emails"];
  for(var i=0; i<consultantIdQueue.length; i++){
    var consultantId=consultantIdQueue[i];
    dbuga('consultantId='+consultantId);
    var member=membersById[consultantId];
    dbuga('member.email='+member.email);
    var consultantLine=member.member_id+"\t"+member.lname+", "+member.fname+"\t"+member.email+"\t"+member.clientEmails.length;
    var emails=member.clientEmails;
    consultantLine+="\t"+emails.join("\t");
    linesArray.push(consultantLine);
    }
  var outStr=linesArray.join("\n");
  $.post("saveit.php", {
    file : "consultants_emails.txt",
    content : outStr
    }, 
    function(data) {
      dbuga('saved <a href="'+data+'">'+data+'</a>');

    });
  }
function outputConsultants(){
  dbuga('outputConsultants()');
  var consultantId=consultantIdQueue.pop();
  dbuga('consultantId='+consultantId);
  var member=membersById[consultantId];
  dbuga('member.email='+member.email);
  var consultantFile="C_"+member.member_id+"_"+member.email+".txt";
  dbuga('consultantFile='+consultantFile);
  consultantFiles.push(consultantFile);
  $.post("saveit.php", {
    file : consultantFile,
    content : JSON.stringify(member)
    }, 
    function(data) {
      dbuga('saved <a href="'+data+'">'+data+'</a>');
      if(consultantIdQueue.length>0){
        window.setTimeout("outputConsultants()",10);
        }
      else{
        consultantIndexWrite();
        }
    });
  }
function consultantIndexWrite(){
  dbuga('consultantIndexWrite()');
  }
var memberIds=[];
var membersById={};
var memberIdsByEmail={};
var assessmentIds=[];
var assessmentsById={};
var assessmentMembers=[];
var assessmentsByMemberId={};
var assessmentsByEmail={};
var assessedEmails=[];


//  question_member_xref
//  question_id, member_id, answer, ib_stamp, assessment_number, remindersent, original_member_id, question_member_xref_id

function parseAssessments(startNum, num){
  dbuga("parseAssessments("+startNum+", "+num+")");
  var fields=cpData.question_member_xref.fields;
  var records=cpData.question_member_xref.records;
  
  //for(var r=0; r<records.length; r++){
  //for(var r=0; r<100000; r++){
  for(var r=startNum; r<startNum+num; r++){
    var parts=records[r].split("\t");
    for (var p=0; p<parts.length; p++){
      if(parts[p]=="\\N"){parts[p]="";}
      }
    var qId=parts[0];
    var mId=parts[1];
    var answer=parts[2];
    var ib_stamp=parts[3];
    var stamps=ib_stamp.split(" ");
    var stamp=stamps[0];
    var aNum=mId+"-"+parts[4];
    var name=membersById[mId].fname+" "+membersById[mId].lname;
    if(valueInArray(mId, assessmentMembers)==false){
      assessmentMembers.push(mId);
      assessmentsByMemberId[mId]={"email":membersById[mId].email, "member_id":mId, "assessments":{}};
      }
      
    var memberAssessmentKeys=Object.keys(assessmentsByMemberId[mId].assessments);
    if(valueInArray(aNum, memberAssessmentKeys)==false){
      var memberRecord=membersById[mId];
      var consultant_id=memberRecord.consultant_id;
      var consultantEmail="";
      if(valueInArray(consultant_id, memberIds)==true){
        var consultantRecord=membersById[consultant_id];
        consultantEmail=consultantRecord.email;
        }
      assessmentsByMemberId[mId].assessments[aNum]={"liscenses":memberRecord.liscenses, "clients":JSON.stringify[memberRecord.clientEmails], "can_see_results":memberRecord.can_see_results, "consultantEmail":consultantEmail, "ib_stamp":stamp, "assessment_number":aNum, "answers":zeroHash(240)};
      }
    assessmentsByMemberId[mId].assessments[aNum].answers[qId]=Number(answer);
    }
  startNum+=num;
  var toNum=startNum+num;
  if(toNum>records.length){toNum=records.length;}
  if(toNum==startNum){
    dbuga(' have assessmentsByMemberId ');
    window.setTimeout('resumeParseAssessments()', 100);
    }
  else{
    window.setTimeout('parseAssessments('+startNum+','+(toNum-startNum)+')', 100);
    }
  }

function resumeParseAssessments(){
  for(var m=0; m<assessmentMembers.length; m++){
    var mId= assessmentMembers[m];
    var assArray=[];
    var assKeys=Object.keys(assessmentsByMemberId[mId].assessments);
    for (var k=0; k<assKeys.length; k++){
      var assKey=assKeys[k];
      var ass=assessmentsByMemberId[mId].assessments[assKey];
      assArray.push(JSON.parse(JSON.stringify(ass)));
      }

    if(membersById[mId].email !=""){
      if(assArray.length>0){// member has assessment(s) and email
        var emails=Object.keys(assessmentsByEmail);
        if(valueInArray(membersById[mId].email, emails)==false){
          assessmentsByEmail[membersById[mId].email]=[];
          assessedEmails.push(membersById[mId].email);
          }
        for(var a=0; a<assArray.length; a++){
          assessmentsByEmail[membersById[mId].email].push(assArray[a]); 
          }
        }
      }
    }
  dbuga('okay have assessmentsByEmail begin output to files ~2300');
  window.setTimeout("outputTick()",10);
  }
var primer=937;
function validateEmail(email) {
  var re = /\S+@\S+\.\S+/;
  return re.test(email);
  }
var fileNumAndEmail=[];
var fileNum=10000;
function outputTick(){
  var email=assessedEmails[emailPointer];
  if(validateEmail(email)){
    fileNum++;
    fileNumAndEmail.push(email+" "+fileNum*primer+" ");
    $.post("saveit.php", {
      file : fileNum*primer +".txt",
      content : JSON.stringify(assessmentsByEmail[email])
      }, 
    function(data) {
      dbuga('saved <a href="'+data+'">'+data+'</a>');
      emailPointer++;
      if(emailPointer<assessedEmails.length){
        window.setTimeout("outputTick()",10);
        }
      else{
        indexWrite();
        }
      });  
    }
  else{//skip invalid emails
    emailPointer++;
    if(emailPointer<assessedEmails.length){
      window.setTimeout("outputTick()",10);
      }
    else{
      indexWrite();
      }
    }
  }
function indexWrite(){
  var outStr=fileNumAndEmail.join("\n");
    $.post("saveit.php", {
      file : "index.txt",
      content : outStr
      }, 
    function(data) {
      dbuga('saved <a href="'+data+'">'+data+'</a>');
      });  

  }
var emailPointer=0;
function zeroHash(limit){
  var theHash={};
  for(var n=1; n<=limit; n++){
    theHash[n]=0;
    }
  return theHash;
  }
function dbug(str) {
  if(str==''){
    ddiv.style.display = "none";
    }
  else{ddiv.style.display = "block";}
  ddiv.innerHTML = str;
  }
function dbuga(str) {
  ddiv.style.display = "block";
  ddiv.innerHTML += "<br />"+str;
  }
function valueInArray(needle, haystack) {
    var length = haystack.length;
    for(var i = 0; i < length; i++) {
        if(haystack[i] == needle) return true;
    }
    return false;
}
</script>
</head>
<body onload="init()" >
<div id="debugDiv"></div>
<div id="output"></div>
<input type="file" id="files" name="files[]" multiple />
<output id="list"></output>
</body>
</html>
